# syntax=docker/dockerfile:1
ARG FRR_VERSION
ARG YANG_VER
ARG YANG_BASE
FROM ubuntu:24.04

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      build-essential autoconf automake libtool pkg-config \
      cmake ninja-build git wget \
      libreadline-dev libjson-c-dev libsnmp-dev libcap-dev \
      python3-dev bison flex \
      libgrpc-dev libprotobuf-dev protobuf-c-compiler \
      libprotobuf-c-dev libelf-dev && \
    wget -q ${YANG_BASE}/libyang2t64_${YANG_VER}_arm64.deb && \
    wget -q ${YANG_BASE}/libyang2-dev_${YANG_VER}_arm64.deb && \
    apt-get install -y ./libyang2t64_${YANG_VER}_arm64.deb \
                       ./libyang2-dev_${YANG_VER}_arm64.deb && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /frr
COPY . .

RUN ./bootstrap.sh && \
    git submodule update --init --recursive && \
    mkdir build && cd build && \
    ../configure --prefix=/usr --sysconfdir=/etc --localstatedir=/var \
                 --enable-grpc --enable-vtysh \
                 --with-pkg-extra-version="-github-${FRR_VERSION}" && \
    make -j"$(nproc)" && \
    checkinstall -D --install=no -y \
      --pkgname=frr --pkgversion=${FRR_VERSION} --pkgrelease=1 \
      --arch=arm64 --pakdir=/frr/pkg make install
